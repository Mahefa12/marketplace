@model IEnumerable<PurchaseRequest>
@using Microsoft.AspNetCore.Identity
@inject UserManager<IdentityUser> UserManager
@{
    ViewData["Title"] = "Admin Dashboard";
    var pendingBooks = ViewData["PendingBooks"] as IEnumerable<Marketplace.Models.Book> ??
    Enumerable.Empty<Marketplace.Models.Book>();
}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h3">Admin Dashboard</h1>
    <form asp-controller="Account" asp-action="Logout" method="post" class="d-inline">
        <button type="submit" class="btn btn-outline-danger">Logout</button>
    </form>
</div>

@if (TempData["Success"] != null)
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        @TempData["Success"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

<!-- Pending Approvals Section -->
<div class="card mb-4">
    <div class="card-header bg-warning text-dark">
        <h5 class="mb-0">ðŸ“‹ Pending Approvals (@pendingBooks.Count())</h5>
    </div>
    <div class="card-body">
        @if (!pendingBooks.Any())
        {
            <p class="text-muted mb-0">No books pending approval.</p>
        }
        else
        {
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Book Details</th>
                            <th>Seller</th>
                            <th>Price</th>
                            <th>Condition</th>
                            <th>Submitted</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var book in pendingBooks)
                        {
                            var seller = await UserManager.FindByIdAsync(book.SellerId);
                            <tr>
                                <td><span class="badge bg-secondary">#BK-@book.Id</span></td>
                                <td>
                                    <div class="fw-semibold">@book.Title</div>
                                    <div class="text-muted small">@book.Author @(!string.IsNullOrWhiteSpace(book.Version) ? $"-                               {book.Version}" : "")</div>
                                </td>
                                <td>
                                    <div>@(seller?.UserName ?? "Unknown")</div>
                                    <div class="text-muted small">@(seller?.Email ?? "No Email")</div>
                                </td>
                                <td class="fw-bold">R@book.Price.ToString("F2")</td>
                                <td><span class="badge bg-info">@book.Condition</span></td>
                                <td class="small">@book.CreatedAt.ToLocalTime().ToString("g")</td>
                                <td>
                                    <div class="btn-group" role="group">
                                        <form asp-action="ApproveBook" method="post" class="d-inline">
                                            <input type="hidden" name="id" value="@book.Id" />
                                            <button type="submit" class="btn btn-sm btn-success"
                                                onclick="return confirm('Approve this book listing?')">âœ“ Approve</button>
                                        </form>
                                        <form asp-action="RejectBook" method="post" class="d-inline ms-1">
                                            <input type="hidden" name="id" value="@book.Id" />
                                            <button type="submit" class="btn btn-sm btn-danger"
                                                onclick="return confirm('Reject and delete this listing?')">âœ— Reject</button>
                                        </form>
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
    </div>
</div>

<!-- Awaiting Payment Section -->
@{
    var awaitingPayment = ViewData["AwaitingPayment"] as IEnumerable<Marketplace.Models.PurchaseRequest> ??
    Enumerable.Empty<Marketplace.Models.PurchaseRequest>();
}
<div class="card mb-4">
    <div class="card-header bg-info text-white">
        <h5 class="mb-0">ðŸ’³ Awaiting Payment Confirmation (@awaitingPayment.Count())</h5>
    </div>
    <div class="card-body">
        @if (!awaitingPayment.Any())
        {
            <p class="text-muted mb-0">No purchases awaiting payment confirmation.</p>
        }
        else
        {
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead>
                        <tr>
                            <th>Request ID</th>
                            <th>Book</th>
                            <th>Buyer</th>
                            <th>Amount</th>
                            <th>Reference</th>
                            <th>Requested</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var pr in awaitingPayment)
                        {
                            var seller = await UserManager.FindByIdAsync(pr.Book?.SellerId ?? "");
                            var buyer = await UserManager.FindByIdAsync(pr.BuyerId);
                            <tr>
                                <td><span class="badge bg-secondary">#PR-@pr.Id</span></td>
                                <td>
                                    <div class="fw-semibold">@pr.Book?.Title</div>
                                    <div class="text-muted small">by @pr.Book?.Author</div>
                                    <div class="mt-1 small">
                                        <strong>Seller:</strong> @(seller?.UserName ?? "Unknown")<br />
                                        <span class="text-muted">@(seller?.Email ?? "No Email")</span>
                                    </div>
                                </td>
                                <td>
                                    <strong>Buyer:</strong> @(buyer?.UserName ?? "Unknown")<br />
                                    <span class="text-muted small">@(buyer?.Email ?? "No Email")</span>
                                </td>
                                <td class="fw-bold">R@pr.OfferPrice</td>
                                <td>
                                    <span class="badge bg-danger">BK-@pr.BookId</span>
                                    <small class="d-block text-muted">Look for this ref in bank</small>
                                </td>
                                <td class="small">@pr.CreatedAt.ToLocalTime().ToString("g")</td>
                                <td>
                                    <div class="btn-group-vertical btn-group-sm">
                                        <form asp-controller="Admin" asp-action="ConfirmPayment" method="post" class="d-inline">
                                            <input type="hidden" name="id" value="@pr.Id" />
                                            <button type="submit" class="btn btn-success mb-1"
                                                onclick="return confirm('Confirm that payment has been received for BK-@pr.BookId?')">
                                                âœ“ Confirm Payment
                                            </button>
                                        </form>
                                        <form asp-controller="Admin" asp-action="CancelReservation" method="post"
                                            class="d-inline">
                                            <input type="hidden" name="id" value="@pr.Id" />
                                            <button type="submit" class="btn btn-outline-danger"
                                                onclick="return confirm('Cancel this reservation? The book will become Active again.')">
                                                âœ— Cancel / Un-reserve
                                            </button>
                                        </form>
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
    </div>
</div>

<!-- Purchase Requests Section -->
<div class="card">
    <div class="card-header bg-primary text-white">
        <h5 class="mb-0">ðŸ’° Purchase Requests</h5>
    </div>
    <div class="card-body">
        @if (!Model.Any())
        {
            <p class="text-muted mb-0">No purchase requests yet.</p>
        }
        else
        {
            <div class="table-responsive">
                <table class="table table-striped align-middle mb-0">
                    <thead>
                        <tr>
                            <th>Book</th>
                            <th>Seller</th>
                            <th>Buyer</th>
                            <th>Status</th>
                            <th>Requested</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var r in Model)
                        {
                            var seller = await UserManager.FindByIdAsync(r.Book?.SellerId ?? "");
                            var buyer = await UserManager.FindByIdAsync(r.BuyerId);
                            <tr>
                                <td>
                                    <div class="fw-semibold">@r.Book?.Title</div>
                                    <div class="text-muted">@r.Book?.Author @(!string.IsNullOrWhiteSpace(r.Book?.Version) ? $"- {r.Book?.Version}" : "")</div>
                                </td>
                                <td>
                                    <div>@(seller?.UserName ?? "Unknown")</div>
                                    <div class="text-muted small">@(seller?.Email ?? "No Email")</div>
                                </td>
                                <td>
                                    <div>@(buyer?.UserName ?? "Unknown")</div>
                                    <div class="text-muted small">@(buyer?.Email ?? "No Email")</div>
                                </td>
                                <td>
                                    <form asp-action="UpdateRequestStatus" method="post"
                                        class="d-flex align-items-center gap-2">
                                        <input type="hidden" name="id" value="@r.Id" />
                                        <select class="form-select form-select-sm" name="status"
                                            asp-items="Html.GetEnumSelectList<Marketplace.Models.PurchaseRequestStatus>()"></select>
                                        <button class="btn btn-sm btn-outline-primary" type="submit">Update</button>
                                    </form>
                                    @if (r.Status == Marketplace.Models.PurchaseRequestStatus.Completed)
                                    {
                                        <a class="btn btn-sm btn-success mt-2" asp-controller="Ratings" asp-action="Create"
                                            asp-route-purchaseRequestId="@r.Id">Collect Rating</a>
                                    }
                                </td>
                                <td>@r.CreatedAt.ToLocalTime().ToString("g")</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
    </div>
</div>